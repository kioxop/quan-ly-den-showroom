<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Quản lý Mẫu Đèn Showroom</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Calm Harmony (Slate/Gray background, Muted Blue for actions, Green/Orange/Yellow for status) -->
    <!-- Application Structure Plan: A two-tab SPA. Tab 1 is a Dashboard & Management view showing current inventory status via a donut chart, key stats, an interactive table for loan/return actions, and a dedicated table for currently loaned items. Tab 2 shows a complete, searchable loan history. This structure separates the 'live' operational view from the 'archival' historical log, which is a more intuitive workflow than Excel sheets. Modals are used for data entry tasks (loaning, returning, adding items) to guide the user and prevent errors. -->
    <!-- Visualization & Content Choices: 1. Inventory Status (Available vs. Loaned): Goal=Inform, Viz=Donut Chart, Interaction=Hover, Justification=At-a-glance overview, Lib=Chart.js/Canvas. 2. Sample List: Goal=Manage, Viz=Interactive HTML Table, Interaction=Search/Sort/Buttons, Justification=Core management interface, Lib=HTML+JS. 3. Loan/Return/Add Forms: Goal=Task Execution, Viz=Modal Forms, Interaction=User Input, Justification=Guided data entry, Lib=HTML+JS. 4. Loan History: Goal=Audit, Viz=Interactive HTML Table, Interaction=Search/Sort, Justification=Easy historical lookup, Lib=HTML+JS. 5. Product Description Generator: Goal=Enhance Data Entry, Viz=Text Area, Interaction=Button click to generate with LLM, Justification=Automate content creation for new items, Lib=Gemini API (gemini-2.0-flash). 6. Sample Image Display: Goal=Visual Identification, Viz=Image, Interaction=None, Justification=Quick visual lookup for items, Lib=HTML (img tag). 7. Project Tracking: Goal=Categorize Loans, Viz=Input Field in Modal, Column in History Table, Interaction=User Input, Justification=Associate loans with specific projects for better tracking and reporting. 8. Loaned Samples Table: Goal=Track Outstanding Loans, Viz=Filtered HTML Table, Interaction=Directly from Dashboard, Justification=Provides a quick overview of currently unreturned items for follow-up. 9. Edit Sample Form: Goal=Update Item Details, Viz=Modal Form, Interaction=User Input to modify existing data fields (name, location, image, description, and now `maDen`), Justification=Allows full data management for existing items, reducing need for re-entry and ensuring data consistency. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-slate-900">Trình Quản Lý Mẫu Đèn Showroom</h1>
            <p class="text-slate-600 mt-1">Công cụ giúp bạn theo dõi và quản lý các mẫu đèn một cách hiệu quả.</p>
            <div class="text-xs text-slate-500 mt-2">
                User ID: <span id="user-id">Đang tải...</span>
            </div>
        </header>

        <div class="border-b border-slate-200 mb-6">
            <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                <button id="tab-dashboard" class="tab-button active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300">
                    Bảng Điều Khiển & Quản Lý
                </button>
                <button id="tab-history" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300">
                    Lịch Sử Mượn Trả
                </button>
            </nav>
        </div>

        <main>
            <div id="content-dashboard" class="tab-content">
                <section id="dashboard-stats" class="mb-8">
                     <div class="mb-6">
                        <h2 class="text-xl font-semibold text-slate-900">Tổng Quan</h2>
                        <p class="text-slate-500 mt-1">Thống kê nhanh về tình trạng các mẫu đèn trong showroom.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm flex flex-col justify-between">
                            <div>
                                <h3 class="text-slate-500 font-medium">Tổng số mẫu đèn</h3>
                                <p id="total-samples" class="text-3xl font-bold text-blue-600 mt-2">0</p>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm flex flex-col justify-between">
                            <div>
                                <h3 class="text-slate-500 font-medium">Đang cho mượn</h3>
                                <p id="loaned-samples" class="text-3xl font-bold text-amber-600 mt-2">0</p>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm flex flex-col justify-between">
                             <div>
                                <h3 class="text-slate-500 font-medium">Sẵn sàng</h3>
                                <p id="available-samples" class="text-3xl font-bold text-green-600 mt-2">0</p>
                            </div>
                        </div>
                         <div class="md:col-span-3 bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-slate-500 font-medium mb-4">Tỷ lệ trạng thái mẫu</h3>
                            <div class="chart-container" style="position: relative; height:250px; width:100%; max-width: 400px; margin: auto;">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="outstanding-loans" class="mb-8">
                    <div class="mb-6">
                        <h2 class="text-xl font-semibold text-slate-900">Mẫu Đèn Đang Cho Mượn</h2>
                        <p class="text-slate-500 mt-1">Bảng này hiển thị tất cả các mẫu đèn hiện đang được mượn, giúp bạn dễ dàng theo dõi và nhắc nhở khi cần.</p>
                    </div>
                    <div class="overflow-x-auto bg-white rounded-lg shadow-sm">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Mã Đèn</th>
                                    <th scope="col" class="px-6 py-3">Tên Mẫu Đèn</th>
                                    <th scope="col" class="px-6 py-3">Vị trí Trưng Bày</th>
                                    <th scope="col" class="px-6 py-3">Người Mượn</th>
                                    <th scope="col" class="px-6 py-3">Dự án</th>
                                    <th scope="col" class="px-6 py-3">Ngày Mượn</th>
                                    <th scope="col" class="px-6 py-3">Ngày Trả Dự Kiến</th>
                                    <th scope="col" class="px-6 py-3">Hành Động</th>
                                </tr>
                            </thead>
                            <tbody id="outstanding-loans-table-body">
                            </tbody>
                        </table>
                    </div>
                </section>
                
                <section id="samples-management">
                     <div class="mb-6">
                        <h2 class="text-xl font-semibold text-slate-900">Danh Sách Toàn Bộ Mẫu Đèn</h2>
                         <p class="text-slate-500 mt-1">Đây là danh sách tổng hợp tất cả các mẫu đèn trong showroom. Bạn có thể tìm kiếm, thêm mới, hoặc thực hiện các thao tác cho mượn/nhận lại từ đây.</p>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                        <input type="text" id="search-samples" placeholder="Tìm kiếm theo mã hoặc tên đèn..." class="w-full sm:w-1/2 px-4 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <button id="btn-add-new" class="w-full sm:w-auto bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">Thêm Mẫu Đèn Mới</button>
                    </div>
                    <div class="overflow-x-auto bg-white rounded-lg shadow-sm">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Hình Ảnh</th>
                                    <th scope="col" class="px-6 py-3">Mã Đèn</th>
                                    <th scope="col" class="px-6 py-3">Tên Mẫu Đèn</th>
                                    <th scope="col" class="px-6 py-3">Vị trí Trưng Bày</th>
                                    <th scope="col" class="px-6 py-3">Trạng Thái</th>
                                    <th scope="col" class="px-6 py-3">Người Mượn Hiện Tại</th>
                                    <th scope="col" class="px-6 py-3">Hành Động</th>
                                </tr>
                            </thead>
                            <tbody id="samples-table-body">
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>

            <div id="content-history" class="tab-content hidden">
                <section id="history-log">
                     <div class="mb-6">
                        <h2 class="text-xl font-semibold text-slate-900">Toàn Bộ Lịch Sử Mượn Trả</h2>
                         <p class="text-slate-500 mt-1">Trang này ghi lại chi tiết tất cả các lượt mượn và trả của từng mẫu đèn. Sử dụng thanh tìm kiếm để tra cứu thông tin nhanh chóng khi cần.</p>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <input type="text" id="search-history" placeholder="Tìm kiếm trong lịch sử..." class="w-full sm:w-1/2 px-4 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div class="overflow-x-auto bg-white rounded-lg shadow-sm">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr>
                                    <th scope="col" class="px-6 py-3">ID Lượt</th>
                                    <th scope="col" class="px-6 py-3">Mã Đèn</th>
                                    <th scope="col" class="px-6 py-3">Tên Mẫu Đèn</th>
                                    <th scope="col" class="px-6 py-3">Người Mượn</th>
                                    <th scope="col" class="px-6 py-3">Dự án</th>
                                    <th scope="col" class="px-6 py-3">Ngày Mượn</th>
                                    <th scope="col" class="px-6 py-3">Ngày Trả Thực Tế</th>
                                    <th scope="col" class="px-6 py-3">Tình Trạng Khi Trả</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body">
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="modal-add-sample" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6 border-b">
                <h3 class="text-lg font-medium">Thêm Mẫu Đèn Mới</h3>
            </div>
            <form id="form-add-sample" class="p-6 space-y-4">
                <div>
                    <label for="new-ma-den" class="block text-sm font-medium text-slate-700">Mã Đèn</label>
                    <input type="text" id="new-ma-den" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="new-ten-mau-den" class="block text-sm font-medium text-slate-700">Tên Mẫu Đèn</label>
                    <input type="text" id="new-ten-mau-den" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                 <div>
                    <label for="new-vi-tri" class="block text-sm font-medium text-slate-700">Vị Trí Trưng Bày/Kiểu Đèn</label>
                    <input type="text" id="new-vi-tri" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="VD: Đèn trần, Đèn bàn, Đèn trang trí...">
                </div>
                <div>
                    <label for="new-hinh-anh-url" class="block text-sm font-medium text-slate-700">URL Hình Ảnh (Tùy chọn)</label>
                    <input type="url" id="new-hinh-anh-url" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="http://example.com/image.jpg">
                </div>
                <div>
                    <label for="new-mo-ta-san-pham" class="block text-sm font-medium text-slate-700">Mô Tả Sản Phẩm</label>
                    <div class="flex items-center gap-2 mt-1">
                        <textarea id="new-mo-ta-san-pham" rows="4" class="block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                        <button type="button" id="btn-generate-description" class="bg-purple-600 text-white text-sm font-semibold p-2 rounded-lg hover:bg-purple-700 transition-colors flex-shrink-0 flex items-center justify-center">
                            Tạo Mô Tả ✨
                        </button>
                    </div>
                    <div id="description-loading" class="hidden text-sm text-slate-500 mt-2 flex items-center">
                        <div class="loading-spinner mr-2"></div> Đang tạo mô tả...
                    </div>
                </div>
                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" class="btn-cancel-modal bg-slate-100 text-slate-700 px-4 py-2 rounded-lg hover:bg-slate-200">Hủy</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Thêm Mới</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="modal-edit-sample" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6 border-b">
                <h3 class="text-lg font-medium">Chỉnh Sửa Mẫu Đèn: <span id="edit-item-name" class="font-bold"></span></h3>
            </div>
            <form id="form-edit-sample" class="p-6 space-y-4">
                <div>
                    <label for="edit-ma-den" class="block text-sm font-medium text-slate-700">Mã Đèn</label>
                    <input type="text" id="edit-ma-den" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="edit-ten-mau-den" class="block text-sm font-medium text-slate-700">Tên Mẫu Đèn</label>
                    <input type="text" id="edit-ten-mau-den" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                 <div>
                    <label for="edit-vi-tri" class="block text-sm font-medium text-slate-700">Vị Trí Trưng Bày/Kiểu Đèn</label>
                    <input type="text" id="edit-vi-tri" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="VD: Đèn trần, Đèn bàn, Đèn trang trí...">
                </div>
                <div>
                    <label for="edit-hinh-anh-url" class="block text-sm font-medium text-slate-700">URL Hình Ảnh (Tùy chọn)</label>
                    <input type="url" id="edit-hinh-anh-url" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="http://example.com/image.jpg">
                </div>
                <div>
                    <label for="edit-mo-ta-san-pham" class="block text-sm font-medium text-slate-700">Mô Tả Sản Phẩm</label>
                    <div class="flex items-center gap-2 mt-1">
                        <textarea id="edit-mo-ta-san-pham" rows="4" class="block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                        <button type="button" id="btn-generate-description-edit" class="bg-purple-600 text-white text-sm font-semibold p-2 rounded-lg hover:bg-purple-700 transition-colors flex-shrink-0 flex items-center justify-center">
                            Tạo Mô Tả ✨
                        </button>
                    </div>
                    <div id="description-loading-edit" class="hidden text-sm text-slate-500 mt-2 flex items-center">
                        <div class="loading-spinner mr-2"></div> Đang tạo mô tả...
                    </div>
                </div>
                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" class="btn-cancel-modal bg-slate-100 text-slate-700 px-4 py-2 rounded-lg hover:bg-slate-200">Hủy</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Lưu Thay Đổi</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-loan-sample" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6 border-b">
                <h3 class="text-lg font-medium">Cho Mượn Mẫu Đèn: <span id="loan-item-name" class="font-bold"></span></h3>
            </div>
            <form id="form-loan-sample" class="p-6 space-y-4">
                <input type="hidden" id="loan-ma-den">
                <div>
                    <label for="loan-nguoi-muon" class="block text-sm font-medium text-slate-700">Người Mượn</label>
                    <input type="text" id="loan-nguoi-muon" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="loan-sdt-email" class="block text-sm font-medium text-slate-700">SĐT/Email Người Mượn</label>
                    <input type="text" id="loan-sdt-email" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="loan-du-an" class="block text-sm font-medium text-slate-700">Dự án</label>
                    <input type="text" id="loan-du-an" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Tên dự án (nếu có)">
                </div>
                <div>
                    <label for="loan-ngay-tra-du-kien" class="block text-sm font-medium text-slate-700">Ngày Trả Dự Kiến</label>
                    <input type="date" id="loan-ngay-tra-du-kien" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                 <div>
                    <label for="loan-tinh-trang-khi-muon" class="block text-sm font-medium text-slate-700">Tình Trạng Khi Mượn</label>
                    <input type="text" id="loan-tinh-trang-khi-muon" value="Tốt, không trầy xước" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" class="btn-cancel-modal bg-slate-100 text-slate-700 px-4 py-2 rounded-lg hover:bg-slate-200">Hủy</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Xác Nhận Cho Mượn</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-return-sample" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6 border-b">
                <h3 class="text-lg font-medium">Nhận Lại Mẫu Đèn: <span id="return-item-name" class="font-bold"></span></h3>
            </div>
            <form id="form-return-sample" class="p-6 space-y-4">
                <input type="hidden" id="return-ma-den">
                <div>
                    <label for="return-tinh-trang-khi-tra" class="block text-sm font-medium text-slate-700">Tình Trạng Khi Trả</label>
                    <input type="text" id="return-tinh-trang-khi-tra" value="Hoàn hảo, không vấn đề" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" class="btn-cancel-modal bg-slate-100 text-slate-700 px-4 py-2 rounded-lg hover:bg-slate-200">Hủy</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Xác Nhận Đã Nhận</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, doc, setDoc, addDoc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables (will be provided by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = 'anonymous'; // Default to anonymous
        let samplesCollection;
        let historyCollection;

        // Ensure DOM is fully loaded before trying to access elements or functions
        document.addEventListener('DOMContentLoaded', () => {
            const userIdDisplay = document.getElementById('user-id');
            let isAuthReady = false; // Flag to ensure auth is ready before Firestore ops

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    samplesCollection = collection(db, `artifacts/${appId}/users/${userId}/samples`);
                    historyCollection = collection(db, `artifacts/${appId}/users/${userId}/history`);
                    isAuthReady = true;
                    // Start listening to Firestore after authentication is ready
                    listenToFirestoreData();
                } else {
                    // Sign in anonymously if no token is provided or user logs out
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Auth Error:", error);
                        userIdDisplay.textContent = 'Lỗi đăng nhập';
                        // Still try to listen to data even if anonymous sign-in fails
                        samplesCollection = collection(db, `artifacts/${appId}/users/${userId}/samples`);
                        historyCollection = collection(db, `artifacts/${appId}/users/${userId}/history`);
                        isAuthReady = true;
                        listenToFirestoreData();
                    }
                }
            });

            // Local data arrays (will be updated by Firestore snapshots)
            window.samplesData = []; // Use window. to make it globally accessible by other scripts
            window.historyData = []; // Use window. to make it globally accessible by other scripts

            const listenToFirestoreData = () => {
                if (!isAuthReady) {
                    console.warn("Firestore listeners called before authentication is ready.");
                    return;
                }
                
                // Real-time listener for samples
                onSnapshot(query(samplesCollection), (snapshot) => {
                    window.samplesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateAll(); // Re-render tables and dashboard
                }, (error) => {
                    console.error("Error fetching samples: ", error);
                });

                // Real-time listener for history
                onSnapshot(query(historyCollection), (snapshot) => {
                    window.historyData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateAll(); // Re-render tables and dashboard
                }, (error) => {
                    console.error("Error fetching history: ", error);
                });
            };

            // --- UI ELEMENTS (remains mostly the same, but now uses window.samplesData/historyData) ---
            const tabDashboard = document.getElementById('tab-dashboard');
            const tabHistory = document.getElementById('tab-history');
            const contentDashboard = document.getElementById('content-dashboard');
            const contentHistory = document.getElementById('content-history');
            const samplesTableBody = document.getElementById('samples-table-body');
            const outstandingLoansTableBody = document.getElementById('outstanding-loans-table-body');
            const historyTableBody = document.getElementById('history-table-body');
            const searchSamplesInput = document.getElementById('search-samples');
            const searchHistoryInput = document.getElementById('search-history');
            
            const btnAddNew = document.getElementById('btn-add-new');
            const modalAddSample = document.getElementById('modal-add-sample');
            const formAddSample = document.getElementById('form-add-sample');

            const modalEditSample = document.getElementById('modal-edit-sample');
            const formEditSample = document.getElementById('form-edit-sample');

            const modalLoanSample = document.getElementById('modal-loan-sample');
            const formLoanSample = document.getElementById('form-loan-sample');

            const modalReturnSample = document.getElementById('modal-return-sample');
            const formReturnSample = document.getElementById('form-return-sample');

            const cancelButtons = document.querySelectorAll('.btn-cancel-modal');
            
            const btnGenerateDescription = document.getElementById('btn-generate-description');
            const newMoTaSanPham = document.getElementById('new-mo-ta-san-pham');
            const descriptionLoading = document.getElementById('description-loading');
            const newHinhAnhUrl = document.getElementById('new-hinh-anh-url');

            const btnGenerateDescriptionEdit = document.getElementById('btn-generate-description-edit');
            const editMoTaSanPham = document.getElementById('edit-mo-ta-san-pham');
            const descriptionLoadingEdit = document.getElementById('description-loading-edit');
            const editHinhAnhUrl = document.getElementById('edit-hinh-anh-url');
            const editTenMauDen = document.getElementById('edit-ten-mau-den');
            const editViTri = document.getElementById('edit-vi-tri');
            const editMaDen = document.getElementById('edit-ma-den');
            const editItemName = document.getElementById('edit-item-name');

            const loanDuAnInput = document.getElementById('loan-du-an');
            
            let statusChart;

            // --- RENDERING FUNCTIONS ---
            const getStatusClass = (status) => {
                switch (status) {
                    case 'Tại Showroom': return 'bg-green-100 text-green-800';
                    case 'Đã Mượn': return 'bg-amber-100 text-amber-800';
                    case 'Đang Bảo Trì': return 'bg-yellow-100 text-yellow-800';
                    default: return 'bg-slate-100 text-slate-800';
                }
            };
            
            const renderSamplesTable = (data = window.samplesData) => {
                samplesTableBody.innerHTML = '';
                if (data.length === 0) {
                     samplesTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-slate-500">Không tìm thấy mẫu đèn nào.</td></tr>`;
                     return;
                }
                data.forEach(item => {
                    const statusClass = getStatusClass(item.tinhTrang);
                    const defaultImageUrl = 'https://placehold.co/60x60/f0f0f0/666666?text=No+Img';
                    const imageUrl = item.hinhAnh && item.hinhAnh.startsWith('http') ? item.hinhAnh : defaultImageUrl;

                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-slate-50';
                    row.innerHTML = `
                        <td class="px-6 py-4">
                            <img src="${imageUrl}" alt="${item.tenMauDen}" class="w-16 h-16 object-cover rounded-md" onerror="this.onerror=null;this.src='${defaultImageUrl}';">
                        </td>
                        <td class="px-6 py-4 font-medium text-slate-900 whitespace-nowrap">${item.maDen}</td>
                        <td class="px-6 py-4">${item.tenMauDen}</td>
                        <td class="px-6 py-4">${item.viTri || '---'}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">
                                ${item.tinhTrang}
                            </span>
                        </td>
                        <td class="px-6 py-4">${item.nguoiMuon || '---'}</td>
                        <td class="px-6 py-4 flex items-center space-x-2">
                            ${item.tinhTrang === 'Tại Showroom' ? `<button class="btn-loan text-blue-600 hover:text-blue-800 font-semibold" data-ma-den="${item.maDen}" data-doc-id="${item.id}">Cho Mượn</button>` : ''}
                            ${item.tinhTrang === 'Đã Mượn' ? `<button class="btn-return text-green-600 hover:text-green-800 font-semibold" data-ma-den="${item.maDen}" data-doc-id="${item.id}">Nhận Lại</button>` : ''}
                            <button class="btn-edit text-slate-600 hover:text-slate-800 font-semibold" data-ma-den="${item.maDen}" data-doc-id="${item.id}">Sửa</button>
                        </td>
                    `;
                    samplesTableBody.appendChild(row);
                });
            };

            const renderOutstandingLoansTable = () => {
                const loanedItems = window.samplesData.filter(s => s.tinhTrang === 'Đã Mượn');
                outstandingLoansTableBody.innerHTML = '';
                if (loanedItems.length === 0) {
                     outstandingLoansTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-10 text-slate-500">Không có mẫu đèn nào đang được cho mượn.</td></tr>`;
                     return;
                }
                loanedItems.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-slate-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 font-medium text-slate-900 whitespace-nowrap">${item.maDen}</td>
                        <td class="px-6 py-4">${item.tenMauDen}</td>
                        <td class="px-6 py-4">${item.viTri || '---'}</td>
                        <td class="px-6 py-4">${item.nguoiMuon || '---'}</td>
                        <td class="px-6 py-4">${item.duAn || '---'}</td>
                        <td class="px-6 py-4">${item.ngayMuon || '---'}</td>
                        <td class="px-6 py-4">${item.ngayTraDuKien || '---'}</td>
                        <td class="px-6 py-4">
                            <button class="btn-return text-green-600 hover:text-green-800 font-semibold" data-ma-den="${item.maDen}" data-doc-id="${item.id}">Nhận Lại</button>
                        </td>
                    `;
                    outstandingLoansTableBody.appendChild(row);
                });
            };

            const renderHistoryTable = (data = window.historyData) => {
                historyTableBody.innerHTML = '';
                 if (data.length === 0) {
                     historyTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-10 text-slate-500">Không có dữ liệu lịch sử.</td></tr>`;
                     return;
                }
                data.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-slate-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 font-medium text-slate-900 whitespace-nowrap">${item.id || item.docId}</td>
                        <td class="px-6 py-4">${item.maDen}</td>
                        <td class="px-6 py-4">${item.tenMauDen}</td>
                        <td class="px-6 py-4">${item.nguoiMuon}</td>
                        <td class="px-6 py-4">${item.duAn || '---'}</td>
                        <td class="px-6 py-4">${item.ngayMuon}</td>
                        <td class="px-6 py-4">${item.ngayTraThucTe || 'Chưa trả'}</td>
                        <td class="px-6 py-4">${item.tinhTrangKhiTra || '---'}</td>
                    `;
                    historyTableBody.appendChild(row);
                });
            };
            
            const renderDashboard = () => {
                const total = window.samplesData.length;
                const loaned = window.samplesData.filter(s => s.tinhTrang === 'Đã Mượn').length;
                const available = window.samplesData.filter(s => s.tinhTrang === 'Tại Showroom').length;
                const maintenance = window.samplesData.filter(s => s.tinhTrang === 'Đang Bảo Trì').length;

                document.getElementById('total-samples').textContent = total;
                document.getElementById('loaned-samples').textContent = loaned;
                document.getElementById('available-samples').textContent = available;
                
                const ctx = document.getElementById('statusChart').getContext('2d');
                const chartData = {
                    labels: ['Sẵn sàng', 'Đang cho mượn', 'Đang bảo trì'],
                    datasets: [{
                        data: [available, loaned, maintenance],
                        backgroundColor: ['#16a34a', '#d97706', '#facc15'],
                        hoverOffset: 4
                    }]
                };
                
                if (statusChart) {
                    statusChart.data = chartData;
                    statusChart.update();
                } else {
                     statusChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                }
                            }
                        }
                    });
                }
            };
            
            const updateAll = () => {
                renderSamplesTable();
                renderOutstandingLoansTable();
                renderHistoryTable();
                renderDashboard();
            }

            // --- EVENT LISTENERS & LOGIC ---
            tabDashboard.addEventListener('click', () => {
                tabDashboard.classList.add('active');
                tabHistory.classList.remove('active');
                contentDashboard.classList.remove('hidden');
                contentHistory.classList.add('hidden');
            });

            tabHistory.addEventListener('click', () => {
                tabHistory.classList.add('active');
                tabDashboard.classList.remove('active');
                contentHistory.classList.remove('hidden');
                contentDashboard.classList.add('hidden');
            });
            
            searchSamplesInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredData = window.samplesData.filter(item => 
                    item.maDen.toLowerCase().includes(searchTerm) ||
                    item.tenMauDen.toLowerCase().includes(searchTerm) ||
                    item.viTri.toLowerCase().includes(searchTerm)
                );
                renderSamplesTable(filteredData);
            });
            
             searchHistoryInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredData = window.historyData.filter(item => 
                    item.id.toLowerCase().includes(searchTerm) ||
                    item.maDen.toLowerCase().includes(searchTerm) ||
                    item.tenMauDen.toLowerCase().includes(searchTerm) ||
                    (item.nguoiMuon && item.nguoiMuon.toLowerCase().includes(searchTerm)) ||
                    (item.duAn && item.duAn.toLowerCase().includes(searchTerm))
                );
                renderHistoryTable(filteredData);
            });

            // Modal handling
            const openModal = (modal) => modal.classList.remove('hidden');
            const closeModal = (modal) => modal.classList.add('hidden');
            
            btnAddNew.addEventListener('click', () => {
                formAddSample.reset();
                newMoTaSanPham.value = '';
                newHinhAnhUrl.value = '';
                openModal(modalAddSample);
            });
            cancelButtons.forEach(btn => btn.addEventListener('click', (e) => closeModal(e.target.closest('.modal-backdrop'))));

            // Add new sample
            formAddSample.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newSampleData = {
                    maDen: document.getElementById('new-ma-den').value,
                    tenMauDen: document.getElementById('new-ten-mau-den').value,
                    viTri: document.getElementById('new-vi-tri').value,
                    tinhTrang: 'Tại Showroom', // Default status
                    nguoiMuon: '', sdtEmail: '', ngayMuon: '', ngayTraDuKien: '', duAn: '', 
                    moTa: newMoTaSanPham.value,
                    hinhAnh: newHinhAnhUrl.value
                };
                try {
                    await addDoc(samplesCollection, newSampleData);
                    closeModal(modalAddSample);
                    e.target.reset();
                } catch (error) {
                    console.error("Error adding document: ", error);
                    alert("Có lỗi khi thêm mẫu đèn. Vui lòng thử lại.");
                }
            });

            // Gemini API Integration: Generate Product Description for Add Modal
            btnGenerateDescription.addEventListener('click', async () => {
                const tenMauDen = document.getElementById('new-ten-mau-den').value;
                const viTri = document.getElementById('new-vi-tri').value;

                if (!tenMauDen) {
                    newMoTaSanPham.value = 'Vui lòng nhập "Tên Mẫu Đèn" để tạo mô tả.';
                    return;
                }

                descriptionLoading.classList.remove('hidden');
                btnGenerateDescription.disabled = true;
                newMoTaSanPham.value = '';

                const prompt = `Viết một mô tả sản phẩm ngắn gọn, hấp dẫn và sáng tạo cho một mẫu đèn trưng bày trong showroom. Mẫu đèn có tên: "${tenMauDen}". Vị trí trưng bày/kiểu đèn gợi ý: "${viTri}". Hãy tập trung vào việc làm nổi bật vẻ đẹp, chức năng và cảm xúc mà nó mang lại cho không gian.`;

                try {
                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = { contents: chatHistory };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        newMoTaSanPham.value = text;
                    } else {
                        newMoTaSanPham.value = 'Không thể tạo mô tả. Vui lòng thử lại.';
                        console.error('API response error:', result);
                    }
                } catch (error) {
                    newMoTaSanPham.value = 'Lỗi kết nối API. Vui lòng kiểm tra mạng và thử lại.';
                    console.error('Fetch error:', error);
                } finally {
                    descriptionLoading.classList.add('hidden');
                    btnGenerateDescription.disabled = false;
                }
            });

            // Edit Sample
            samplesTableBody.addEventListener('click', e => {
                if(e.target.classList.contains('btn-edit')) {
                    const docId = e.target.dataset.docId;
                    const sample = window.samplesData.find(s => s.id === docId);
                    if (sample) {
                        editItemName.textContent = sample.tenMauDen;
                        editMaDen.value = sample.maDen;
                        editMaDen.dataset.originalMaDen = sample.maDen; // Store original maDen
                        editMaDen.dataset.docId = docId; // Store docId for update
                        editTenMauDen.value = sample.tenMauDen;
                        editViTri.value = sample.viTri;
                        editHinhAnhUrl.value = sample.hinhAnh;
                        editMoTaSanPham.value = sample.moTa;
                        openModal(modalEditSample);
                    }
                }
            });

            // Gemini API Integration: Generate Product Description for Edit Modal
            btnGenerateDescriptionEdit.addEventListener('click', async () => {
                const tenMauDen = document.getElementById('edit-ten-mau-den').value;
                const viTri = document.getElementById('edit-vi-tri').value;

                if (!tenMauDen) {
                    editMoTaSanPham.value = 'Vui lòng nhập "Tên Mẫu Đèn" để tạo mô tả.';
                    return;
                }

                descriptionLoadingEdit.classList.remove('hidden');
                btnGenerateDescriptionEdit.disabled = true;
                editMoTaSanPham.value = '';

                const prompt = `Viết một mô tả sản phẩm ngắn gọn, hấp dẫn và sáng tạo cho một mẫu đèn trưng bày trong showroom. Mẫu đèn có tên: "${tenMauDen}". Vị trí trưng bày/kiểu đèn gợi ý: "${viTri}". Hãy tập trung vào việc làm nổi bật vẻ đẹp, chức năng và cảm xúc mà nó mang lại cho không gian.`;

                try {
                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = { contents: chatHistory };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        editMoTaSanPham.value = text;
                    } else {
                        editMoTaSanPham.value = 'Không thể tạo mô tả. Vui lòng thử lại.';
                        console.error('API response error:', result);
                    }
                } catch (error) {
                    editMoTaSanPham.value = 'Lỗi kết nối API. Vui lòng kiểm tra mạng và thử lại.';
                    console.error('Fetch error:', error);
                } finally {
                    descriptionLoadingEdit.classList.add('hidden');
                    btnGenerateDescriptionEdit.disabled = false;
                }
            });

            formEditSample.addEventListener('submit', async (e) => {
                e.preventDefault();
                const originalMaDen = editMaDen.dataset.originalMaDen;
                const docIdToUpdate = editMaDen.dataset.docId; // Get the Firestore document ID
                const newMaDen = editMaDen.value;

                // Check for duplicate newMaDen if it's being changed
                if (newMaDen !== originalMaDen) {
                    const isDuplicate = window.samplesData.some(s => s.maDen === newMaDen);
                    if (isDuplicate) {
                        alert('Mã Đèn mới đã tồn tại. Vui lòng chọn Mã Đèn khác.');
                        return;
                    }
                }

                try {
                    // Update the sample document in Firestore
                    await setDoc(doc(samplesCollection, docIdToUpdate), {
                        maDen: newMaDen,
                        tenMauDen: editTenMauDen.value,
                        viTri: editViTri.value,
                        hinhAnh: editHinhAnhUrl.value,
                        moTa: editMoTaSanPham.value,
                        // Preserve existing fields like tinhTrang, nguoiMuon, etc.
                        // Fetch the current sample data to merge, or use updateDoc for specific fields
                        ...window.samplesData.find(s => s.id === docIdToUpdate)
                    }, { merge: true });

                    // Update maDen in history documents
                    const historyDocsQuery = query(historyCollection);
                    const historySnapshot = await getDocs(historyDocsQuery);
                    historySnapshot.forEach(async (historyDoc) => {
                        if (historyDoc.data().maDen === originalMaDen) {
                            await updateDoc(doc(historyCollection, historyDoc.id), {
                                maDen: newMaDen,
                                tenMauDen: editTenMauDen.value // Also update tenMauDen in history for consistency
                            });
                        }
                    });

                    closeModal(modalEditSample);
                } catch (error) {
                    console.error("Error updating document: ", error);
                    alert("Có lỗi khi lưu thay đổi. Vui lòng thử lại.");
                }
            });

            // Loan sample
            samplesTableBody.addEventListener('click', e => {
                if(e.target.classList.contains('btn-loan')) {
                    const docId = e.target.dataset.docId; // Use docId
                    const sample = window.samplesData.find(s => s.id === docId);
                    document.getElementById('loan-item-name').textContent = sample.tenMauDen;
                    document.getElementById('loan-ma-den').value = docId; // Store docId here for reference
                    document.getElementById('loan-ngay-tra-du-kien').valueAsDate = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
                    
                    loanDuAnInput.value = '';
                    openModal(modalLoanSample);
                }
            });

            formLoanSample.addEventListener('submit', async (e) => {
                e.preventDefault();
                const docId = document.getElementById('loan-ma-den').value; // Retrieve docId
                const sample = window.samplesData.find(s => s.id === docId);
                const today = new Date().toISOString().split('T')[0];
                
                // Update sample status in Firestore
                try {
                    await updateDoc(doc(samplesCollection, docId), {
                        tinhTrang: 'Đã Mượn',
                        nguoiMuon: document.getElementById('loan-nguoi-muon').value,
                        sdtEmail: document.getElementById('loan-sdt-email').value,
                        ngayMuon: today,
                        ngayTraDuKien: document.getElementById('loan-ngay-tra-du-kien').value,
                        duAn: document.getElementById('loan-du-an').value,
                    });

                    // Add history entry to Firestore
                    await addDoc(historyCollection, {
                        maDen: sample.maDen,
                        tenMauDen: sample.tenMauDen,
                        viTriKhiMuon: sample.viTri,
                        nguoiMuon: document.getElementById('loan-nguoi-muon').value,
                        sdtEmail: document.getElementById('loan-sdt-email').value,
                        ngayMuon: today,
                        ngayTraDuKien: document.getElementById('loan-ngay-tra-du-kien').value,
                        duAn: document.getElementById('loan-du-an').value,
                        ngayTraThucTe: '',
                        tinhTrangKhiTra: '',
                        sampleDocId: docId // Reference to the samples document
                    });

                    closeModal(modalLoanSample);
                    e.target.reset();
                } catch (error) {
                    console.error("Error during loan operation: ", error);
                    alert("Có lỗi khi cho mượn đèn. Vui lòng thử lại.");
                }
            });

            // Return sample
            document.querySelectorAll('#samples-table-body, #outstanding-loans-table-body').forEach(table => {
                table.addEventListener('click', e => {
                    if(e.target.classList.contains('btn-return')) {
                        const docId = e.target.dataset.docId; // Use docId
                        const sample = window.samplesData.find(s => s.id === docId);
                        document.getElementById('return-item-name').textContent = sample.tenMauDen;
                        document.getElementById('return-ma-den').value = docId; // Store docId here
                        openModal(modalReturnSample);
                    }
                });
            });

            formReturnSample.addEventListener('submit', async (e) => {
                e.preventDefault();
                const docId = document.getElementById('return-ma-den').value; // Retrieve docId
                const sample = window.samplesData.find(s => s.id === docId);
                const today = new Date().toISOString().split('T')[0];

                // Update sample status in Firestore
                try {
                    await updateDoc(doc(samplesCollection, docId), {
                        tinhTrang: 'Tại Showroom',
                        nguoiMuon: '',
                        sdtEmail: '',
                        ngayMuon: '',
                        ngayTraDuKien: '',
                        duAn: '',
                    });

                    // Update the corresponding history entry
                    // Find the outstanding history item by sampleDocId and empty ngayTraThucTe
                    const historyQuery = query(historyCollection);
                    const historySnapshot = await getDocs(historyQuery);
                    let outstandingHistoryDoc = null;
                    historySnapshot.forEach(doc => {
                        if (doc.data().sampleDocId === docId && doc.data().ngayTraThucTe === '') {
                            outstandingHistoryDoc = doc;
                        }
                    });

                    if (outstandingHistoryDoc) {
                        await updateDoc(doc(historyCollection, outstandingHistoryDoc.id), {
                            ngayTraThucTe: today,
                            tinhTrangKhiTra: document.getElementById('return-tinh-trang-khi-tra').value,
                        });
                    } else {
                        console.warn("No outstanding history found for this sample. Creating a new one for return.");
                        // Fallback: Add a new history entry for return if somehow no outstanding one is found
                        await addDoc(historyCollection, {
                            maDen: sample.maDen,
                            tenMauDen: sample.tenMauDen,
                            viTriKhiMuon: sample.viTri, // Store viTri when borrowed
                            nguoiMuon: sample.nguoiMuon, // Should be populated from current sample loan data
                            sdtEmail: sample.sdtEmail, // Should be populated from current sample loan data
                            ngayMuon: sample.ngayMuon, // Should be populated from current sample loan data
                            ngayTraDuKien: sample.ngayTraDuKien, // Should be populated from current sample loan data
                            duAn: sample.duAn,
                            ngayTraThucTe: today,
                            tinhTrangKhiTra: document.getElementById('return-tinh-trang-khi-tra').value,
                            sampleDocId: docId
                        });
                    }
                    
                    closeModal(modalReturnSample);
                    e.target.reset();
                } catch (error) {
                    console.error("Error during return operation: ", error);
                    alert("Có lỗi khi nhận lại đèn. Vui lòng thử lại.");
                }
            });
        });
    </script>
</body>
</html>
